<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Song Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --border: #1e1e2e;
  --accent: #7fff6a;
  --accent2: #ff6a6a;
  --accent3: #4a9eff;
  --text: #e8e8f0;
  --muted: #555570;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: 'Noto Sans Thai', 'Space Mono', monospace; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; }

header {
  width: 100%; max-width: 560px;
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 2rem; padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
header h1 { font-family: 'Space Mono', monospace; font-size: 1.25rem; letter-spacing: -0.02em; }
header h1 span { color: var(--accent); }
.header-right { display: flex; gap: 0.75rem; align-items: center; }
.progress-text { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--muted); }

.btn { padding: 0.5rem 1rem; font-family: 'Space Mono', monospace; font-size: 0.75rem; font-weight: 700; border-radius: 4px; cursor: pointer; border: 1px solid; transition: all 0.15s; }
.btn-ghost { background: none; border-color: var(--border); color: var(--muted); }
.btn-ghost:hover { border-color: var(--text); color: var(--text); }
.btn-accent { background: var(--accent); border-color: var(--accent); color: #0a0a0f; }
.btn-accent:hover { opacity: 0.85; }
.btn-danger { background: none; border-color: var(--accent2); color: var(--accent2); }
.btn-danger:hover { background: var(--accent2); color: #0a0a0f; }

/* Upload */
#uploadSection { width: 100%; max-width: 560px; }
.upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: border-color 0.2s; }
.upload-zone:hover { border-color: var(--accent); }
.upload-zone .icon { font-size: 2.5rem; margin-bottom: 1rem; }
.upload-zone p { color: var(--muted); font-family: 'Space Mono', monospace; font-size: 0.85rem; }
#fileInput { display: none; }

/* Card */
#editorSection { display: none; width: 100%; max-width: 560px; }

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.card-art {
  width: 100%; height: 220px;
  object-fit: cover;
  background: var(--border);
  display: block;
}

.card-body { padding: 1.5rem; }
.card-track { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.3rem; line-height: 1.3; }
.card-artist { font-size: 0.8rem; color: var(--muted); margin-bottom: 1.5rem; }

/* Sliders */
.param-row {
  margin-bottom: 1.25rem;
}
.param-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.5rem;
}
.step-btns { display: flex; gap: 4px; flex-wrap: wrap; }
.step-btn {
  width: 40px; height: 30px;
  background: var(--bg); border: 1px solid var(--border);
  color: var(--muted); font-family: 'Space Mono', monospace; font-size: 0.65rem;
  border-radius: 4px; cursor: pointer; transition: all 0.1s;
}
.step-btn.active { color: #0a0a0f; border-color: transparent; font-weight: 700; }
.param-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.4rem;
}
.param-label { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }
.param-value { font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; }

input[type="range"] {
  width: 100%; height: 4px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); border-radius: 2px; outline: none; cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid var(--bg);
}

/* BPM special */
.bpm-section { margin-bottom: 1.5rem; }
.bpm-display {
  font-family: 'Space Mono', monospace;
  font-size: 3rem; font-weight: 700;
  text-align: center;
  color: var(--accent);
  margin-bottom: 0.75rem;
  line-height: 1;
}
.bpm-display span { font-size: 1rem; color: var(--muted); }
.bpm-modes { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.bpm-mode-btn {
  flex: 1; padding: 0.5rem; font-family: 'Space Mono', monospace; font-size: 0.7rem;
  background: var(--bg); border: 1px solid var(--border); color: var(--muted);
  border-radius: 4px; cursor: pointer; transition: all 0.15s; text-align: center;
}
.bpm-mode-btn.active { border-color: var(--accent); color: var(--accent); }

.tap-btn {
  width: 100%; padding: 1.5rem;
  background: var(--bg); border: 2px solid var(--border);
  color: var(--text); font-family: 'Space Mono', monospace; font-size: 1rem;
  border-radius: 12px; cursor: pointer; transition: all 0.1s;
  user-select: none;
}
.tap-btn:active { background: var(--surface); border-color: var(--accent); transform: scale(0.98); }
.tap-hint { font-size: 0.7rem; color: var(--muted); margin-top: 0.5rem; text-align: center; font-family: 'Space Mono', monospace; }

/* Actions */
.card-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
.card-actions .btn { flex: 1; text-align: center; padding: 0.75rem; font-size: 0.8rem; }

/* Done state */
#doneSection { display: none; width: 100%; max-width: 560px; text-align: center; padding: 3rem 0; }
#doneSection .icon { font-size: 3rem; margin-bottom: 1rem; }
#doneSection h2 { font-family: 'Space Mono', monospace; font-size: 1.5rem; margin-bottom: 0.5rem; }
#doneSection p { color: var(--muted); font-size: 0.85rem; margin-bottom: 2rem; }
</style>
</head>
<body>

<header>
  <h1>SONG <span>EDITOR</span></h1>
  <div class="header-right">
    <span class="progress-text" id="progressText"></span>
    <button class="btn btn-accent" id="exportBtn" onclick="exportCSV()" style="display:none;padding:0.4rem 0.9rem;font-size:0.7rem">‚¨áÔ∏è Export</button>
    <button class="btn btn-ghost" id="reloadBtn" onclick="document.getElementById('reloadInput').click()" style="display:none;padding:0.4rem 0.9rem;font-size:0.7rem" title="‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà reset progress">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</button>
    <input type="file" id="reloadInput" accept=".csv" style="display:none" onchange="reloadCSV(event)">
    <a href="bpm_viewer.html" class="btn btn-ghost">‚Üê Viewer</a>
  </div>
</header>

<div id="uploadSection">
  <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
    <div class="icon">üéõÔ∏è</div>
    <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV ‡∏à‡∏≤‡∏Å Exportify</p>
    <p style="font-size:0.7rem;margin-top:0.4rem;opacity:0.6">‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å BPM Viewer ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
  </div>
  <input type="file" id="fileInput" accept=".csv" onchange="loadCSV(event)">
  <div style="text-align:center;margin-top:1.5rem">
    <button class="btn btn-ghost" onclick="loadFromStorage()">‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å BPM Viewer</button>
  </div>
</div>

<div id="editorSection">
  <div class="card">
    <img class="card-art" id="cardArt" src="" alt="">
    <div class="card-body">
      <div class="card-track" id="cardTrack"></div>
      <div class="card-artist" id="cardArtist"></div>

      <!-- BPM -->
      <div class="bpm-section">
        <div class="bpm-display" id="bpmDisplay">-- <span>BPM</span></div>
        <div class="bpm-modes">
          <div class="bpm-mode-btn active" onclick="setBpmMode('slider', this)">üéö Slider</div>
          <div class="bpm-mode-btn" onclick="setBpmMode('tap', this)">üëÜ Tap</div>
        </div>
        <div id="bpmSliderWrap">
          <input type="range" id="bpmSlider" min="40" max="220" value="120"
            oninput="onBpmSlider(this.value)"
            style="accent-color:var(--accent)">
        </div>
        <div id="bpmTapWrap" style="display:none">
          <button class="tap-btn" onclick="tapBpm()" onkeydown="if(event.code==='Space') tapBpm()">
            ü•Å ‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞
          </button>
          <div class="tap-hint" id="tapHint">‡πÅ‡∏ï‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BPM</div>
          <button class="btn btn-ghost" style="width:100%;margin-top:0.5rem;font-size:0.7rem" onclick="resetTap()">reset tap</button>
        </div>
      </div>

      <!-- Energy -->
      <div class="param-row">
        <div class="param-header">
          <span class="param-label">Energy</span>
          <span class="param-value" id="energyVal" style="color:#ff6a6a"></span>
        </div>
        <div class="step-btns" id="energyBtns" data-param="energy" data-color="#ff6a6a"></div>
      </div>

      <!-- Valence -->
      <div class="param-row">
        <div class="param-header">
          <span class="param-label">Valence (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç)</span>
          <span class="param-value" id="valenceVal" style="color:#f1c40f"></span>
        </div>
        <div class="step-btns" id="valenceBtns" data-param="valence" data-color="#f1c40f"></div>
      </div>

      <!-- Danceability -->
      <div class="param-row">
        <div class="param-header">
          <span class="param-label">Danceability</span>
          <span class="param-value" id="danceVal" style="color:#7fff6a"></span>
        </div>
        <div class="step-btns" id="danceBtns" data-param="dance" data-color="#7fff6a"></div>
      </div>

      <!-- Mood tag -->
      <div class="param-row">
        <div class="param-header">
          <span class="param-label">Mood Tag (optional)</span>
        </div>
        <input type="text" id="moodTag" placeholder="‡πÄ‡∏ä‡πà‡∏ô sad, chill, hype..."
          style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.75rem;font-family:'Space Mono',monospace;font-size:0.8rem;border-radius:6px;outline:none">
      </div>

      <div class="card-actions">
        <button class="btn btn-ghost" id="prevBtn" onclick="prevSong()" style="flex:0 0 auto;padding:0.75rem 1rem" title="‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">‚Üê</button>
        <button class="btn btn-danger" onclick="skipSong()">‚úì ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ</button>
        <button class="btn btn-accent" onclick="saveSong()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>
</div>

<div id="doneSection">
  <div class="icon">üéâ</div>
  <h2>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
  <p id="doneText"></p>
  <button class="btn btn-accent" onclick="exportCSV()" style="margin-bottom:0.75rem;width:100%;padding:0.75rem">‚¨áÔ∏è Export CSV</button>
  <button class="btn btn-ghost" onclick="restartEditor()" style="width:100%;padding:0.75rem">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
</div>

<script>
let songs = [], current = 0, edits = {}, tapTimes = [], bpmMode = 'slider';
const artCache = JSON.parse(localStorage.getItem('bpm_artcache')||'{}');

function loadFromStorage(){
  const csv = localStorage.getItem('bpm_csv');
  if(!csv){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å BPM Viewer'); return; }
  initEditor(parseCSV(csv));
}

function reloadCSV(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const newData = parseCSV(ev.target.result.replace(/^\uFEFF/,''));
    // ‡πÄ‡∏Å‡πá‡∏ö edits ‡πÅ‡∏•‡∏∞ current ‡πÑ‡∏ß‡πâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á
    songs = newData;
    localStorage.setItem('bpm_csv', ev.target.result.replace(/^\uFEFF/,''));
    updateExportBtn();
    showSong();
    // reset input ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
    e.target.value = '';
  };
  reader.readAsText(file, 'UTF-8');
}

function loadCSV(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => initEditor(parseCSV(ev.target.result.replace(/^\uFEFF/,'')));
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text){
  const lines = text.split('\n').filter(l=>l.trim());
  const headers = parseLine(lines[0]);
  return lines.slice(1).map(line => {
    const vals = parseLine(line);
    const obj = {};
    headers.forEach((h,i) => obj[h.trim()] = (vals[i]||'').trim());
    return obj;
  }).filter(r => r['Track Name']);
}

function parseLine(line){
  const res=[]; let cur='', inQ=false;
  for(const c of line){
    if(c==='"') inQ=!inQ;
    else if(c===','&&!inQ){res.push(cur);cur='';}
    else cur+=c;
  }
  res.push(cur); return res;
}

function initEditor(data){
  songs = data;
  current = 0;
  edits = {};
  loadSession(); // ‡πÇ‡∏´‡∏•‡∏î progress ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorSection').style.display = 'block';
  document.getElementById('exportBtn').style.display = 'inline-block';
  document.getElementById('reloadBtn').style.display = 'inline-block';
  updateExportBtn();
  showSong();
}

function v(r,k){ return parseFloat(r[k])||0; }

function showSong(){
  if(current >= songs.length){ showDone(); return; }
  const r = songs[current];
  const total = songs.length;
  document.getElementById('progressText').textContent = `${current+1} / ${total}`;
  const prevBtn = document.getElementById('prevBtn');
  if(prevBtn) prevBtn.disabled = current === 0;

  document.getElementById('cardTrack').textContent = r['Track Name'];
  document.getElementById('cardArtist').textContent = r['Artist Name(s)']||'';

  const tid = (r['Track URI']||'').replace('spotify:track:','');
  const spotifyUri = tid ? `spotify:track:${tid}` : '';

  const trackEl = document.getElementById('cardTrack');
  if(spotifyUri){
    trackEl.innerHTML = `<a href="${spotifyUri}" style="color:inherit;text-decoration:none;border-bottom:1px solid var(--border)" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">${r['Track Name']}</a>`;
  } else {
    trackEl.textContent = r['Track Name'];
  }

  const art = document.getElementById('cardArt');
  art.src = artCache[tid] || '';
  art.style.display = artCache[tid] ? 'block' : 'none';

  // BPM
  const bpm = Math.round(v(r,'Tempo')) || 120;
  document.getElementById('bpmSlider').value = Math.min(220, Math.max(40, bpm));
  document.getElementById('bpmDisplay').innerHTML = `${bpm} <span>BPM</span>`;

  // sliders -> step btns
  paramState.energy = Math.round(v(r,'Energy')*10)*10 || 50;
  paramState.valence = Math.round(v(r,'Valence')*10)*10 || 50;
  paramState.dance = Math.round(v(r,'Danceability')*10)*10 || 50;
  // snap to nearest 10
  paramState.energy = Math.round(paramState.energy/10)*10;
  paramState.valence = Math.round(paramState.valence/10)*10;
  paramState.dance = Math.round(paramState.dance/10)*10;
  renderStepBtns();
  document.getElementById('moodTag').value = '';

  tapTimes = [];
  document.getElementById('tapHint').textContent = '‡πÅ‡∏ï‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BPM';
}

function getCurrentValues(){
  return {
    bpm: parseFloat(document.getElementById('bpmDisplay').textContent),
    energy: paramState.energy / 100,
    valence: paramState.valence / 100,
    dance: paramState.dance / 100,
    moodTag: document.getElementById('moodTag').value.trim(),
  };
}

function updateExportBtn(){
  const n = Object.keys(edits).length;
  const btn = document.getElementById('exportBtn');
  if(btn) btn.textContent = n > 0 ? `‚¨áÔ∏è Export (${n})` : '‚¨áÔ∏è Export';
}

function prevSong(){
  if(current <= 0) return;
  current--;
  saveSession();
  showSong();
}

function skipSong(){ current++; saveSession(); showSong(); }

function saveSong(){
  edits[current] = getCurrentValues();
  current++;
  saveSession();
  updateExportBtn();
  showSong();
}

const STEPS = [10,20,30,40,50,60,70,80,90,100];
const paramState = { energy: 50, valence: 50, dance: 50 };
const paramConfig = {
  energy:  { el: 'energyBtns',  val: 'energyVal',  color: '#ff6a6a' },
  valence: { el: 'valenceBtns', val: 'valenceVal',  color: '#f1c40f' },
  dance:   { el: 'danceBtns',   val: 'danceVal',    color: '#7fff6a' },
};

function renderStepBtns(){
  Object.entries(paramConfig).forEach(([param, cfg]) => {
    const wrap = document.getElementById(cfg.el);
    wrap.innerHTML = STEPS.map(s =>
      `<button class="step-btn ${paramState[param]===s?'active':''}"
        style="${paramState[param]===s?`background:${cfg.color};`:''}border-color:${paramState[param]===s?cfg.color:'var(--border)'}"
        onclick="setParam('${param}', ${s})">${s}</button>`
    ).join('');
    document.getElementById(cfg.val).textContent = paramState[param] + '%';
    document.getElementById(cfg.val).style.color = cfg.color;
  });
}

function setParam(param, val){
  paramState[param] = val;
  renderStepBtns();
}

function saveSession(){
  localStorage.setItem('editor_current', current);
  localStorage.setItem('editor_edits', JSON.stringify(edits));
}

function loadSession(){
  const savedIdx = localStorage.getItem('editor_current');
  const savedEdits = localStorage.getItem('editor_edits');
  if(savedIdx !== null) current = parseInt(savedIdx);
  if(savedEdits) edits = JSON.parse(savedEdits);
}

function onBpmSlider(val){
  document.getElementById('bpmDisplay').innerHTML = `${val} <span>BPM</span>`;
}

// Tap BPM
function setBpmMode(mode, btn){
  bpmMode = mode;
  document.querySelectorAll('.bpm-mode-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('bpmSliderWrap').style.display = mode==='slider' ? 'block' : 'none';
  document.getElementById('bpmTapWrap').style.display = mode==='tap' ? 'block' : 'none';
}

function tapBpm(){
  const now = Date.now();
  tapTimes.push(now);
  if(tapTimes.length > 8) tapTimes.shift(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 8 tap ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

  if(tapTimes.length < 2){
    document.getElementById('tapHint').textContent = '‡πÅ‡∏ï‡∏∞‡∏ï‡πà‡∏≠...';
    return;
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì avg interval
  const intervals = [];
  for(let i=1; i<tapTimes.length; i++) intervals.push(tapTimes[i]-tapTimes[i-1]);
  const avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
  const bpm = Math.round(60000/avg);
  const clamped = Math.min(220, Math.max(40, bpm));

  document.getElementById('bpmDisplay').innerHTML = `${clamped} <span>BPM</span>`;
  document.getElementById('bpmSlider').value = clamped;
  document.getElementById('tapHint').textContent = `${tapTimes.length} taps ‚Äî ${clamped} BPM`;
}

function resetTap(){
  tapTimes = [];
  document.getElementById('tapHint').textContent = '‡πÅ‡∏ï‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BPM';
}

// keyboard spacebar tap
document.addEventListener('keydown', e => {
  if(e.code==='Space' && bpmMode==='tap' && document.getElementById('editorSection').style.display!=='none'){
    e.preventDefault();
    tapBpm();
  }
});

function showDone(){
  document.getElementById('editorSection').style.display = 'none';
  document.getElementById('doneSection').style.display = 'block';
  const edited = Object.keys(edits).length;
  document.getElementById('doneText').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${edited} ‡πÄ‡∏û‡∏•‡∏á ‡∏à‡∏≤‡∏Å ${songs.length} ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`;
}

function exportCSV(){
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
  const original = [...songs];
  Object.entries(edits).forEach(([idx, vals]) => {
    const r = {...original[idx]};
    r['Tempo'] = vals.bpm.toString();
    r['Energy'] = vals.energy.toString();
    r['Valence'] = vals.valence.toString();
    r['Danceability'] = vals.dance.toString();
    if(vals.moodTag) r['Mood Tag'] = vals.moodTag;
    original[idx] = r;
  });

  const headers = Object.keys(original[0]);
  const rows = [headers.join(',')];
  original.forEach(r => {
    rows.push(headers.map(h => {
      const val = (r[h]||'').toString();
      return val.includes(',') ? `"${val}"` : val;
    }).join(','));
  });

  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'BPM_Project_edited.csv';
  a.click(); URL.revokeObjectURL(url);
}

function restartEditor(){
  localStorage.removeItem('editor_current');
  localStorage.removeItem('editor_edits');
  document.getElementById('doneSection').style.display = 'none';
  document.getElementById('uploadSection').style.display = 'block';
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å storage ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('bpm_csv');
  if(saved) {
    initEditor(parseCSV(saved));
  }
});
</script>
</body>
</html>
